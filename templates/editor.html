{% extends "base.html" %}
{% block head %}
  <style>
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .row { display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    input[type="text"]{
      width: min(520px, 100%); padding:10px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--text);
    }
    .tags {
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .tags input {
      width: 200px; padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--text);
    }
    textarea{
      width:100%; min-height:70vh; resize:none; padding:12px; border-radius:12px;
      border:1px solid var(--border); background:var(--card); color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.5; tab-size:2;
    }
    .preview{
      min-height:70vh; padding:16px; border-radius:12px; border:1px solid var(--border);
      background:var(--card); overflow:auto;
    }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .toolbtn{
      background:transparent; color:var(--text); border:1px solid var(--border);
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:.95rem;
    }
    .toolbtn:hover{ background:rgba(31,111,235,.12); }
    .toolbtn[disabled]{ opacity:.5; cursor:not-allowed; }
    /* Split handle */
    .split-wrap{ position:relative; display:grid; grid-template-columns: 1fr 10px 1fr; gap:14px; }
    .gutter{
      width:10px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px dashed var(--border); cursor:col-resize;
    }
    /* Outline / TOC */
    .toc{
      margin-top:10px; padding:10px; border:1px solid var(--border); border-radius:12px;
      background:var(--card); max-height:26vh; overflow:auto; font-size:.95rem;
    }
    .toc a{ display:block; padding:3px 0; color:var(--muted); text-decoration:none; }
    .toc a:hover{ color:var(--text); text-decoration:underline; }
    .muted{ color: var(--muted); }
    /* Status bar */
    .status{
      display:flex; gap:12px; align-items:center; justify-content:flex-end; margin-top:8px; font-size:.9rem;
      color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; margin-right:6px; }
    .ok{ background:#10b981; } .warn{ background:#f59e0b; }
    .danger{ background:#dc2626; }
    .right{ margin-left:auto; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border:1px solid var(--border); border-bottom-width:2px; padding:2px 6px; border-radius:6px; font-size:.85rem;
    }
  </style>
{% endblock %}

{% block body %}
  <form method="post" action="{{ url_for('new_doc') if not doc else url_for('edit_doc', doc_id=doc.id) }}" enctype="multipart/form-data">
    <div class="row">
      <input type="text" name="title" placeholder="Title" value="{{ '' if not doc else doc.title }}" aria-label="Document title">
      <div class="tags">
        <input type="text" name="tags" placeholder="tags (comma separated)"
          value="{% if doc %}{{ doc.tags|default('') }}{% else %}{% endif %}" aria-label="Tags"/>

        <span class="muted">Press <span class="kbd">Ctrl/‚åò+S</span> to save</span>
      </div>
      <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
        <!-- Formatting -->
        <button type="button" class="toolbtn" data-ins="**bold**" title="Bold">B</button>
        <button type="button" class="toolbtn" data-ins="*italic*" title="Italic"><i>i</i></button>
        <button type="button" class="toolbtn" data-ins="`code`" title="Inline code">{ }</button>
        <button type="button" class="toolbtn" data-ins="```python\nprint('hello')\n```" title="Code block">```</button>
        <button type="button" class="toolbtn" data-ins="[title](https://)" title="Link">üîó</button>
        <button type="button" class="toolbtn" data-ins="- item\n- item\n- item" title="List">‚Ä¢ List</button>
        <button type="button" class="toolbtn" data-ins="- [ ] task" title="Task list">‚òê</button>
        <button type="button" class="toolbtn" data-ins="| col1 | col2 |\n|---|---|\n| a | b |" title="Table">‚ñ¶</button>
        <!-- Math -->
        <button type="button" class="toolbtn" data-ins="$E=mc^2$" title="Inline math">$x$</button>
        <button type="button" class="toolbtn" data-ins="$$\n\\int_0^1 x^2\\,dx = \\tfrac{1}{3}\n$$" title="Display math">$$</button>
        <!-- Insert image (paste/upload) -->
        <label class="toolbtn" title="Upload image">
          üñº Upload <input type="file" name="image" id="img-input" accept="image/*" hidden>
        </label>
        <!-- View -->
        <button type="button" class="toolbtn" id="toggle-toc" title="Toggle outline/TOC">‚ò∞ TOC</button>
        <button type="button" class="toolbtn" id="toggle-wrap" title="Toggle line wrap">‚Üî Wrap</button>
        <button type="button" class="toolbtn" id="fullscreen" title="Fullscreen">‚§¢</button>

        {% if doc %}
          <a class="toolbtn" href="{{ url_for('download_md', doc_id=doc.id) }}">Download .md</a>
          <a class="toolbtn" href="{{ url_for('export_html', doc_id=doc.id) }}">Export .html</a>
          <a class="toolbtn" href="{{ url_for('list_shares', doc_id=doc.id) }}">Share</a>
        {% endif %}
        <button class="btn" type="submit">Save</button>
      </div>
    </div>

    <!-- Split editor/preview with draggable gutter -->
    <div class="split-wrap">
      <div class="card">
        <textarea id="editor" name="content" placeholder="Write Markdown + LaTeX here..." aria-label="Editor">{% if doc %}{{ doc.content }}{% endif %}</textarea>
        <div class="muted" style="margin-top:8px;">
          Tip: Use <code>$...$</code> for inline math and <code>$$...$$</code> for display math. Paste an image directly to auto-upload and insert Markdown.
        </div>

        <!-- Outline / TOC -->
        <details id="toc-wrap" style="margin-top:10px;">
          <summary class="muted">Document Outline</summary>
          <nav class="toc" id="toc"></nav>
        </details>
      </div>

      <div class="gutter" id="gutter" role="separator" aria-orientation="vertical" aria-label="Resize editor/preview"></div>

      <div class="card preview" id="preview"><em class="muted">Live preview will appear here‚Ä¶</em></div>
    </div>

    <!-- Status bar -->
    <div class="status">
      <span><span id="save-dot" class="dot warn"></span><span id="save-status">Unsaved</span></span>
      <span class="right" id="metric-words">0 words</span>
      <span id="metric-chars">0 chars</span>
      <span id="metric-read">~0 min read</span>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<script>
  const ta = document.getElementById("editor");
  const preview = document.getElementById("preview");
  const toc = document.getElementById("toc");
  const tocWrap = document.getElementById("toc-wrap");
  const saveDot = document.getElementById("save-dot");
  const saveStatus = document.getElementById("save-status");
  const metricWords = document.getElementById("metric-words");
  const metricChars = document.getElementById("metric-chars");
  const metricRead = document.getElementById("metric-read");
  const toggleTOC = document.getElementById("toggle-toc");
  const toggleWrap = document.getElementById("toggle-wrap");
  const imgInput = document.getElementById("img-input");
  const fullBtn = document.getElementById("fullscreen");

  const DOC_KEY = (() => {
    const id = "{{ doc.id if doc else 'new' }}";
    return `nmbc_editor_draft_${id}`;
  })();

  // --- Toolbar insertion helpers ---
  function insertSnippet(snippet){
    const el = ta;
    const start = el.selectionStart, end = el.selectionEnd;
    const before = el.value.substring(0,start);
    const selected = el.value.substring(start,end) || "";
    const after = el.value.substring(end);
    let out = snippet;
    // replace placeholder selections if present
    if(snippet.includes("**bold**") && selected){
      out = `**${selected}**`;
    } else if(snippet.includes("*italic*") && selected){
      out = `*${selected}*`;
    } else if(snippet.includes("`code`") && selected){
      out = "`"+selected+"`";
    }
    el.value = before + out + after;
    const cursor = (before + out).length;
    el.setSelectionRange(cursor, cursor);
    el.dispatchEvent(new Event("input"));
    el.focus();
  }
  document.querySelectorAll(".toolbtn[data-ins]").forEach(btn=>{
    btn.addEventListener("click", ()=> insertSnippet(btn.dataset.ins));
  });

  // --- Preview (debounced) ---
  let t = null;
  async function updatePreview() {
    const text = ta.value || "";
    try{
      const res = await fetch("{{ url_for('api_preview') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({text})
      });
      const data = await res.json();
      preview.innerHTML = data.html || "";
      renderPreview(preview);
      buildTOC();
    } catch(e){
      preview.innerHTML = "<p style='color:#dc2626'>Preview error.</p>";
    }
  }
  function schedule(){ if (t) clearTimeout(t); t = setTimeout(()=>{ updatePreview(); saveStatusDirty(); }, 220); }

  // --- Metrics ---
  function updateMetrics(){
    const text = ta.value || "";
    const words = (text.trim().match(/\b\w+\b/g) || []).length;
    const chars = text.length;
    const readMin = Math.max(1, Math.round(words / 220));
    metricWords.textContent = `${words} words`;
    metricChars.textContent = `${chars} chars`;
    metricRead.textContent = `~${readMin} min read`;
  }

  // --- Autosave drafts (localStorage) ---
  let lastSaved = null;
  function saveDraft(){
    try{
      localStorage.setItem(DOC_KEY, JSON.stringify({ content: ta.value, ts: Date.now() }));
      lastSaved = new Date();
      saveDot.className = "dot ok";
      saveStatus.textContent = `Saved ${lastSaved.toLocaleTimeString()}`;
    }catch(_){}
  }
  function saveStatusDirty(){
    saveDot.className = "dot warn";
    saveStatus.textContent = "Unsaved changes";
  }
  // Restore draft if newer than server version (best-effort)
  (function maybeRestore(){
    try{
      const raw = localStorage.getItem(DOC_KEY);
      if(!raw) return;
      const draft = JSON.parse(raw);
      const hasServer = Boolean({% if doc and doc.content %}true{% else %}false{% endif %});
      if(!hasServer && draft?.content){
        ta.value = draft.content;
      }
    }catch(_){}
  })();

  // Periodic autosave
  setInterval(()=>{ if(document.activeElement === ta) saveDraft(); }, 5000);

  // --- Image paste & upload hook ---
  async function uploadImage(blob){
    // If you have a real endpoint, swap '/api/upload' for it
    const endpoint = "/api/upload"; // implement server-side: returns {url}
    const form = new FormData();
    form.append("file", blob, `img_${Date.now()}.png`);
    try{
      const res = await fetch(endpoint, { method:"POST", body: form });
      const data = await res.json();
      if(data?.url){
        insertSnippet(`![image](${data.url})`);
      } else {
        alert("Upload failed.");
      }
    }catch(e){ alert("Upload error."); }
  }
  ta.addEventListener("paste", (e)=>{
    const item = [...(e.clipboardData?.items || [])].find(it=> it.type.startsWith("image/"));
    if(item){
      e.preventDefault();
      const file = item.getAsFile();
      if(file) uploadImage(file);
    }
  });
  imgInput?.addEventListener("change", ()=>{
    const f = imgInput.files?.[0];
    if(f) uploadImage(f);
    imgInput.value = "";
  });

  // --- TOC builder ---
  function buildTOC(){
    const heads = preview.querySelectorAll("h1, h2, h3, h4, h5, h6");
    const items = [];
    heads.forEach(h=>{
      if(!h.id){
        h.id = h.textContent.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
      }
      const level = parseInt(h.tagName[1],10);
      items.push({ level, id: h.id, text: h.textContent });
    });
    toc.innerHTML = items.map(i=>`<a href="#${i.id}" style="padding-left:${(i.level-1)*8}px">${"".padStart(i.level-1,"‚Ä¢ ")}${i.text}</a>`).join("") || `<div class="muted">No headings yet.</div>`;
  }
  toggleTOC?.addEventListener("click", ()=> { tocWrap.open = !tocWrap.open; });

  // --- Line wrap toggle ---
  let wrapped = true;
  toggleWrap?.addEventListener("click", ()=>{
    wrapped = !wrapped;
    ta.style.whiteSpace = wrapped ? "pre-wrap" : "pre";
  });

  // --- Fullscreen preview/editor ---
  fullBtn?.addEventListener("click", ()=>{
    const body = document.documentElement;
    if(!document.fullscreenElement){ body.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
  });

  // --- Draggable splitter ---
  (function splitDrag(){
    const gutter = document.getElementById("gutter");
    const parent = gutter.parentElement;
    let dragging = false;
    let startX = 0, leftW = 0, rightW = 0;
    function px(n){ return `${n}px`; }
    function onDown(e){
      dragging = true;
      startX = e.clientX || (e.touches?.[0]?.clientX);
      const rects = parent.getBoundingClientRect();
      const left = parent.children[0].getBoundingClientRect();
      const right = parent.children[2].getBoundingClientRect();
      leftW = left.width; rightW = right.width;
      document.body.style.cursor = "col-resize";
      e.preventDefault();
    }
    function onMove(e){
      if(!dragging) return;
      const x = e.clientX || (e.touches?.[0]?.clientX);
      const dx = x - startX;
      const newLeft = Math.max(240, leftW + dx);
      const newRight = Math.max(240, rightW - dx);
      parent.style.gridTemplateColumns = `${px(newLeft)} 10px ${px(newRight)}`;
    }
    function onUp(){
      if(!dragging) return;
      dragging = false;
      document.body.style.cursor = "default";
    }
    gutter.addEventListener("mousedown", onDown);
    gutter.addEventListener("touchstart", onDown, {passive:false});
    window.addEventListener("mousemove", onMove);
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("mouseup", onUp);
    window.addEventListener("touchend", onUp);
  })();

  // --- Keyboard: Save (Ctrl/Cmd+S) ---
  window.addEventListener("keydown", (e) => {
    const mod = navigator.platform.includes("Mac") ? e.metaKey : e.ctrlKey;
    if (mod && e.key.toLowerCase() === "s") {
      e.preventDefault();
      e.stopPropagation();
      e.target.closest("form").submit();
    }
  });

  // --- Live wiring ---
  function onInput(){
    schedule();
    updateMetrics();
  }
  document.addEventListener("DOMContentLoaded", ()=>{
    // initial pass
    ta.style.whiteSpace = "pre-wrap";
    updatePreview();
    updateMetrics();
    saveStatusDirty();
  });
  ta.addEventListener("input", onInput);
</script>
{% endblock %}
